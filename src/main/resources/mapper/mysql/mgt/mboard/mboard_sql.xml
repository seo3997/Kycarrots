<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mgt.mboard">	
	
	
	<select id="selectTotCntBoard" parameterType="dataMap" resultType="int">
	/* mgt.mboard.selectTotCntBoard */
	SELECT COUNT(1) AS TOT_CNT
	FROM tb_board A
	WHERE A.DELETE_YN = 'N'
	<include refid="whereParam" />
	</select>


	<select id="selectPageListBoard" parameterType="dataMap" resultType="dataMap">
		<if test="limitStart != null">
			<![CDATA[
			   SELECT AA.*
			   FROM(
			]]>	
		</if>			
		<include refid="selectParam" />
		<include refid="whereParam" />
		<if test=" limitStart != null">
			<![CDATA[
	    			ORDER BY A.UPDT_DT DESC
				) AA
				LIMIT #{limitStart},#{limitEnd}
			]]>
		</if>
	</select>

	<select id="selectListBoard" parameterType="dataMap" resultType="dataMap">
		SELECT A.BBS_SEQ
			, A.BBS_SE_CODE_L
			, A.BBS_SE_CODE_M
			, C.CODE_NM AS BBS_SE_NM
			, A.SJ
			, A.CN
			, A.ATCH_DOC_ID
			, A.REGISTER_NO
			, B.USER_NM AS REGISTER_NM
			,DATE_FORMAT(A.REGIST_DT, '%Y.%m.%d') AS REGIST_DT 
		FROM tb_board A
		INNER JOIN op_user B
		ON A.REGISTER_NO = B.USER_NO
		LEFT  JOIN op_code C  	ON A.BBS_SE_CODE_L=C.GROUP_ID 	AND A.BBS_SE_CODE_M = C.CODE 
		WHERE A.DELETE_YN = 'N'
		AND A.BBS_SE_CODE_M  = #{sch_bbs_se_code}
 		ORDER BY A.UPDT_DT DESC
		LIMIT 0,5
	</select>


	<sql id="selectParam">
			SELECT A.BBS_SEQ
				, A.BBS_SE_CODE_L
				, A.BBS_SE_CODE_M
				, C.CODE_NM AS BBS_SE_NM
				, A.SJ
				, A.ATCH_DOC_ID
				, A.REGISTER_NO
				, B.USER_NM AS REGISTER_NM
				,DATE_FORMAT(A.REGIST_DT, '%Y.%m.%d') AS REGIST_DT 
			FROM tb_board A
			INNER JOIN op_user B
			ON A.REGISTER_NO = B.USER_NO
			LEFT  JOIN op_code C  	ON A.BBS_SE_CODE_L=C.GROUP_ID 	AND A.BBS_SE_CODE_M = C.CODE 
			WHERE A.DELETE_YN = 'N'
	</sql>

	<sql id="whereParam">
		   AND A.BBS_SE_CODE_M  = #{sch_bbs_se_code}
		<if test="sch_text != null and sch_text != ''">
			AND CONCAT(A.SJ, A.CN) LIKE CONCAT('%',#{sch_text},'%')
		</if>
	</sql>
	
	<select id="selectBoard" parameterType="dataMap" resultType="dataMap">
	/* mgt.mboard.selectBoard */
	SELECT A.BBS_SEQ
		, A.BBS_SE_CODE_L
		, A.BBS_SE_CODE_M
		, C.CODE_NM AS BBS_SE_NM
		, A.SJ
		, A.CN
		, A.ATCH_DOC_ID
		, A.HIT_CNT
		, A.DELETE_YN
		, A.REGISTER_NO
        , DATE_FORMAT(A.REGIST_DT, '%Y.%m.%d') AS REGIST_DT 
		, B.USER_NM AS REGISTER_NM
	FROM tb_board A 	INNER JOIN op_user B	ON A.REGISTER_NO = B.USER_NO
	LEFT  JOIN op_code C  	ON A.BBS_SE_CODE_L=C.GROUP_ID 	AND A.BBS_SE_CODE_M = C.CODE 
	WHERE 	A.BBS_SEQ = #{bbs_seq}
	AND 		A.DELETE_YN = 'N'
	</select>
		
	<insert id="insertBoard" parameterType="dataMap">
	/*  mgt.mboard.insertBoard */
	INSERT INTO tb_board (
	    BBS_SEQ
		,BBS_SE_CODE_L
		,BBS_SE_CODE_M
		, SJ
		, CN
		, ATCH_DOC_ID
		, HIT_CNT
		, DELETE_YN
		, REGISTER_NO
		, REGIST_DT
		, UPDUSR_NO
		, UPDT_DT
	) values (
		(select * from (select ifnull(max(bbs_seq),0)+1 from tb_board) next)
		,#{bbs_se_code_l}
		,#{bbs_se_code_m}
		,#{sj}
		,#{cn}
		,#{atch_doc_id}
		, 0
		,'N'
		,#{ss_user_no}
		, CURRENT_TIMESTAMP
		,#{ss_user_no}
		, CURRENT_TIMESTAMP
	)
	</insert>

	<update id="updateBoard" parameterType="dataMap">
	/*  mgt.mboard.updateBoard */
	UPDATE tb_board
	SET SJ = #{sj}
		, CN = #{cn}
		, ATCH_DOC_ID = #{atch_doc_id}
		, UPDUSR_NO = #{ss_user_no}
		, UPDT_DT = CURRENT_TIMESTAMP
	WHERE BBS_SEQ = #{bbs_seq}
	</update>
	
	<update id="deleteBoard" parameterType="dataMap">
	/* mgt.mboard.deleteBoard */
	UPDATE tb_board
	SET DELETE_YN = 'Y'
	WHERE BBS_SEQ = #{bbs_seq}
	</update>

	<update id="deleteBoardComment" parameterType="dataMap">
	/* mgt.mboard.deleteComment */
	DELETE FROM  op_board_comment
	WHERE COMMENT_BOARD	= #{bbs_seq}
	</update>

	
</mapper>